#!/usr/bin/groovy

pipeline {
  agent {
    kubernetes {
      yamlFile "Petclinic-Real/jenkins-agent-pod-template.yml"
    }
  }

  options {
      disableConcurrentBuilds()
      buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '5'))
  }

  environment {
    PROJECT = "PetClinic"
    REGISTRY_USER = "vjkancherla"
    GIT_COMMIT_HASH = sh (script: "git log -n 1 --pretty=format:'%H'", returnStdout: true)
    IMAGE_REPO = "vjkancherla/petclinic"
    IMAGE_TAG = "${GIT_COMMIT_HASH}"
  }

  stages {
    stage ("Build") {
      steps {
        container("maven") {
            sh 'cd Petclinic-Real'
            sh 'ls -l'
            sh 'mvn clean package'
        }
      }
    }
  }

}
